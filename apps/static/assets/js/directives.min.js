/*! technology-radar 08-11-2016 */
"use strict";var cuDirectives=angular.module("cuDirectives",[]);cuDirectives.directive("radarDiagram",["$log","TechnologyRadar","$rootScope","$sce",function(a,b,c,d){return{restrict:"E",templateUrl:"/static/partials/radar.html",replace:!0,link:function(b,e,f){var g=function(){function a(a,b,c){function d(a,b){var c=(Math.PI*Math.pow(a,2)*Math.pow(e,2)-b)/Math.PI;return c>0?Math.sqrt(c):0}for(var e=1,f=Math.PI*Math.pow(a,2),g=f/b,h=b-1,i=a;h-- >c;)i=d(i,g);return Math.max(0,d(i,g))}function g(a){var c=70,d=10,e=!1;return _.each(b.technologies,function(b){a!==b&&a.x&&a.y&&b.x&&b.y&&Math.abs(a.x-b.x)<c&&Math.abs(a.y-b.y)<d&&(e=!0)}),e}function h(a,b){e=a.innerRadius+G,f=a.outerRadius-G;var c=Math.random()*(f-e)+e,d=Math.atan(G/c),e=a.startAngle+d,f=a.endAngle-d,g=Math.random()*(f-e)+e;b.x=c*Math.cos(g-Math.PI/2),b.y=c*Math.sin(g-Math.PI/2)}function i(a){return a.length<=M?a:a.substring(0,M-1)+"..."}function j(){J=L.selectAll("g").data(function(a){return a.technologies},function(a){return a.label});var a=J.enter().append("g").attr("class","tech-label").on("mouseover",function(a){if(!b.viewTech){a.active=!0,b.setVariables("activeTechLabel",a.label),this.parentNode.__data__.active=!0;var c={label:a.label,description:a.description,color:this.parentNode.__data__.color};b.setVariables("tech_data",c),d3.selectAll("text").style("opacity",.3),d3.selectAll("circle").style("opacity",.3),d3.selectAll("text").filter(function(a){if(a.label==b.activeTechLabel)return!0}).style("opacity",1).style("font-weight","bold").style("cursor","pointer"),d3.selectAll("circle").filter(function(a){if(a.label==b.activeTechLabel)return!0}).style("opacity",1)}m()}).on("mouseout",function(a){b.viewTech||(a.active=!1,b.setVariables("tech_data",{}),d3.selectAll("text").style("opacity",1).style("font-weight","normal").style("cursor","default"),b.hideLables()),m()}).on("click",function(a){b.setVariables("viewTech",!0);({status:this.parentElement.parentNode.__data__.label,category:this.parentElement.__data__.label,tech:{label:a.label,description:a.description}});c.$broadcast("setActiveTab",this.parentElement.parentElement.__data__),c.$broadcast("showInfo",this.parentElement.parentElement.__data__,a),z.style("visibility","visible"),z.style("opacity","1"),z.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX-200+"px"),z.html('<div class="panel panel-primary"><div class="panel-heading text-center">'+a.label+'<i class="fa fa-times pull-right" ng-click="closeInfo()"></i></div><div class="panel-body"><label>Status : </label> <label style="color:'+this.parentElement.__data__.color+';"> '+this.parentElement.parentElement.__data__.label+"</label><br><label> Description : </label> <span>"+d.trustAsHtml(a.description)+"</span></div></div>"),$("div.tooltip i").on("click",function(){z.style("visibility","hidden"),d3.selectAll("text").style("opacity",1).style("font-weight","normal").style("cursor","default"),b.viewTech=!1})});a.append("text").datum(function(a){for(var b=d3.select(this.parentNode.parentNode).datum();!a.x||!a.y||g(a);)h(b.arc,a);return a}).text(function(a){return i(a.label)}).attr("x",function(a){return a.x+E+5}).attr("y",function(a){return a.y+3.5}),a.append("circle").attr("r",E).style("stroke","grey").style("fill","whitesmoke").attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),J.exit().remove()}function k(a,b){return function(c){return 0==c?i(a):a.substring(0,Math.round((a.length-b)*c)+b)}}function l(a,b){return function(c){var d=c*(a.length-b);return 1==c?i(a):a.substring(0,a.length-d)}}function m(){b.$apply(),J.selectAll("text").transition().duration(150).tween("text",function(a){var b=a.active?k:l,c=b(a.label,Math.min(this.textContent.length,M));if(c(1)!==this.textContent)return function(a){this.textContent=c(a)}}),J.selectAll("circle").transition().duration(500).attr("r",function(a){return a.active?F:a.radius?a.radius:E})}$(e).html("");var n=b.categories.length,o=[];_(n).times(function(){o.push(100/n)});var p=f.width,q=f.height,r=30,s=Math.min(f.width,f.height)/2-r,t=d3.scale.category20c().domain(_.range(20)),u=d3.scale.category20c().copy(),v=_.groupBy(t.range(),function(a,b){return Math.floor(b/4)});u.range(_.flatten(_.map(v,function(a){var b=[];return _.each(a,function(a,c,d){b.push(a),c<d.length-1&&b.push(d3.interpolateRgb(a,d[c+1])(.5))}),b}))),u.domain(_.range(35));var w=d3.layout.pie().sort(null),x=w(o),y={Tools:x[0],Techniques:x[1],Platforms:x[2],Languages:x[3]},z=d3.select("body").append("div").attr("class","tooltip").style("width","300px").style("position","absolute").style("z-index","10").style("visibility","hidden"),A=d3.svg.arc(),B=d3.select(e[0]).append("svg").attr("width",p).attr("height",q).attr("id","radar"),C=B.append("g").attr("transform","translate("+(p/2-r)+","+(q/2-r)+")"),D=B.append("g").attr("transform","translate("+(p/2-r)+","+(q/2-r)+")"),E=5,F=7,G=10,H=C.selectAll("g").data(b.techList).enter().append("g").attr("class","ring"),I=H.selectAll("path").data(function(a){return a.categories}).enter().append("g").attr("class","slice");I.append("path").attr("fill",function(a,b,c){return u(7*b+c+2)}).attr("stroke","grey").attr("stroke-width","1px").attr("stroke-opacity",".25").datum(function(c,d,e){var f=this,g=_.size(b.statuses);return c.arc={innerRadius:a(s,g,e),outerRadius:e==g-1?s:a(s,g,e+1),color:f.getAttribute("fill")},_.extend(c.arc,y[c.label]),c}).attr("d",function(a){return A.innerRadius(a.arc.innerRadius).outerRadius(a.arc.outerRadius)(a.arc)}).on("mouseover",function(a){b.viewTech||(a.active=!0,m())}).on("mouseout",function(a){b.viewTech||(a.active=!1,m())});var J,K=D.selectAll("g").data(b.techList).enter().append("g").attr("class","tech"),L=K.selectAll("g").data(function(a){return a.categories}).enter().append("g").datum(function(a,b){var c=this;return a.color=c.__data__.arc.color,a}).attr("class","category"),M=15;b.$watch("techList",function(){j(),b.displayLabels()},!0),j()};g(),b.$on("redraw",function(b,c){a.info(" Redraw Triggered"),g()})}}}]);